import streamlit as st
import pandas as pd
import ssl
import altair as alt
import numpy as np

# üîß –û–±—Ö–æ–¥ SSL
ssl._create_default_https_context = ssl._create_unverified_context

# üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤")

# üîó CSV-—Å—Å—ã–ª–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π
url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSigXcrNvRJII0f0bRwOhUGr4r5chw6NqxGjuiw2H18PlcdoAuewonaMGgE_oy4a5MHbzVifX67wulr/pub?output=csv'
df = pd.read_csv(url)

# ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
if 'Unnamed: 0' in df.columns:
    df.rename(columns={'Unnamed: 0': '–ö–æ–º–ø–∞–Ω–∏—è'}, inplace=True)

# üîÑ –ó–∞–º–µ–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π
df['–ö–æ–º–ø–∞–Ω–∏—è'] = df['–ö–æ–º–ø–∞–Ω–∏—è'].replace({
    '–ê–ª—å—Ñ–∞': '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫',
    '–û–∑–æ–Ω': 'Ozon'
})

# üî† –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
company_list_sorted = sorted(df['–ö–æ–º–ø–∞–Ω–∏—è'].unique())

# ‚öôÔ∏è Session state
if 'selected_companies' not in st.session_state:
    st.session_state.selected_companies = company_list_sorted

# üîò –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–º –∫–æ–º–ø–∞–Ω–∏–π
col1, col2, col3 = st.columns(3)
with col1:
    if st.button("–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"):
        st.session_state.selected_companies = company_list_sorted
with col2:
    if st.button("–°–±—Ä–æ—Å–∏—Ç—å"):
        st.session_state.selected_companies = []
with col3:
    if st.button("–¢–û–ü-5"):
        top5 = ['–ê–≤–∏—Ç–æ', '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫', '–¢-–±–∞–Ω–∫', '–Ø–Ω–¥–µ–∫—Å', 'Ozon']
        st.session_state.selected_companies = [c for c in top5 if c in df['–ö–æ–º–ø–∞–Ω–∏—è'].unique()]

# üîç –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç –∫–æ–º–ø–∞–Ω–∏–π
companies = st.multiselect(
    "–í—ã–±–µ—Ä–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    options=company_list_sorted,
    default=st.session_state.selected_companies,
    key="selected_companies"
)

# ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ –∏ –ø–æ—Ä—è–¥–∫–∞ –ø–ª–æ—â–∞–¥–æ–∫
platform_order = ['–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–∞—Ä—å–µ—Ä–Ω—ã–µ —Å–∞–π—Ç—ã', 'HH', 'Getmatch', 'Habr Career']
platform_colors = {
    'Getmatch': 'yellow',
    'HH': 'red',
    'Habr Career': 'green',
    '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–∞—Ä—å–µ—Ä–Ω—ã–µ —Å–∞–π—Ç—ã': 'skyblue'
}

# üîç –§–∏–ª—å—Ç—Ä –ø–ª–æ—â–∞–¥–æ–∫
if 'selected_platforms' not in st.session_state:
    st.session_state.selected_platforms = platform_order

selected_platforms = st.multiselect(
    "–ö–∞—Ä—å–µ—Ä–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏",
    options=platform_order,
    default=st.session_state.selected_platforms,
    key="selected_platforms"
)

# üìå –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è DataFrame
filtered_df = df[df['–ö–æ–º–ø–∞–Ω–∏—è'].isin(companies)]

# üî∑ **–§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π —Ü–≤–µ—Ç–Ω–æ–π –ª–µ–≥–µ–Ω–¥—ã**
def render_platform_legend():
    legend_html = ""
    for p in selected_platforms:
        color = platform_colors[p]
        legend_html += f"<span style='font-size:12px; color:{color}; font-weight:bold'>‚¨§ {p}</span> &nbsp;&nbsp;"
    st.markdown(legend_html, unsafe_allow_html=True)

# üìà **Bar chart**
st.subheader("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–∞ –ø–ª–æ—â–∞–¥–∫–∞—Ö –≤—Å–µ–≥–æ")
render_platform_legend()

if not filtered_df.empty:
    bar_df = filtered_df[['–ö–æ–º–ø–∞–Ω–∏—è'] + selected_platforms]
    vacancies_sum = bar_df.drop(columns=['–ö–æ–º–ø–∞–Ω–∏—è']).sum().reindex(selected_platforms).reset_index()
    vacancies_sum.columns = ['–ü–ª–æ—â–∞–¥–∫–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']

    color_scale = alt.Scale(domain=selected_platforms,
                            range=[platform_colors[p] for p in selected_platforms])

    bar_chart = alt.Chart(vacancies_sum).mark_bar().encode(
        x=alt.X('–ü–ª–æ—â–∞–¥–∫–∞', sort=selected_platforms),
        y='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
        color=alt.Color('–ü–ª–æ—â–∞–¥–∫–∞', scale=color_scale, legend=None)
    ).properties(width=700)

    st.altair_chart(bar_chart)
else:
    st.write("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–ø–∞–Ω–∏—é.")

# üìà **Line chart**
st.subheader("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–∞ –∫–∞–∂–¥–æ–π –∏–∑ –ø–ª–æ—â–∞–¥–æ–∫")
render_platform_legend()

if not filtered_df.empty:
    line_df = filtered_df[['–ö–æ–º–ø–∞–Ω–∏—è'] + selected_platforms]
    line_df['–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π'] = line_df[selected_platforms].sum(axis=1)
    line_df = line_df.sort_values('–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π', ascending=False)
    line_df.drop(columns=['–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π'], inplace=True)

    line_df_melt = line_df.melt(id_vars='–ö–æ–º–ø–∞–Ω–∏—è', var_name='–ü–ª–æ—â–∞–¥–∫–∞', value_name='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ')
    line_df_melt = line_df_melt[line_df_melt['–ü–ª–æ—â–∞–¥–∫–∞'].isin(selected_platforms)]

    line_chart = alt.Chart(line_df_melt).mark_line(point=True).encode(
        x=alt.X('–ö–æ–º–ø–∞–Ω–∏—è', sort=line_df['–ö–æ–º–ø–∞–Ω–∏—è'].tolist()),
        y='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
        color=alt.Color('–ü–ª–æ—â–∞–¥–∫–∞', scale=color_scale, legend=None)
    ).properties(width=700)

    st.altair_chart(line_chart)
else:
    st.write("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞.")

# üñ•Ô∏è **–û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É**
st.subheader("–î–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–º–ø–∞–Ω–∏—è–º")
st.dataframe(filtered_df, use_container_width=True)

# üìå ================================
# üî∑ –î–û–ë–ê–í–õ–ï–ù–ò–ï –í–¢–û–†–û–ì–û –õ–ò–°–¢–ê - –†–ï–ô–¢–ò–ù–ì–ò
# üìå ================================

ratings_url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSigXcrNvRJII0f0bRwOhUGr4r5chw6NqxGjuiw2H18PlcdoAuewonaMGgE_oy4a5MHbzVifX67wulr/pub?gid=1694021447&single=true&output=tsv'
ratings_df = pd.read_csv(ratings_url, encoding='utf-8', sep='\t')
ratings_df.rename(columns=lambda x: x.strip(), inplace=True)

# üîÑ –ó–∞–º–µ–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π –∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–º DataFrame
ratings_df['–ö–æ–º–ø–∞–Ω–∏—è'] = ratings_df['–ö–æ–º–ø–∞–Ω–∏—è'].replace({
    '–ê–ª—å—Ñ–∞': '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫',
    '–û–∑–æ–Ω': 'Ozon'
})

# üî∑ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–º–ø–∞–Ω–∏—è–º
ratings_df = ratings_df[ratings_df['–ö–æ–º–ø–∞–Ω–∏—è'].isin(companies)]

# üî∑ –°–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
platform_rating_cols = ['DreamJob', 'Habr Career', 'Glassdoor']

# üî† –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ —É–±—ã–≤–∞–Ω–∏—é DreamJob
ratings_df = ratings_df.sort_values('DreamJob', ascending=False)

# üî∑ –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.subheader("–†–µ–π—Ç–∏–Ω–≥–∏ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º")

# üî∑ –õ–µ–≥–µ–Ω–¥–∞
rating_platform_colors = {
    'DreamJob': 'red',
    'Habr Career': 'green',
    'Glassdoor': 'gray',
}

legend_html = ""
for p in rating_platform_colors.keys():
    color = rating_platform_colors[p]
    legend_html += f"<span style='font-size:12px; color:{color}; font-weight:bold'>‚¨§ {p}</span> &nbsp;&nbsp;"
st.markdown(legend_html, unsafe_allow_html=True)

# üîÑ Melt –¥–ª—è Altair
ratings_melt = ratings_df.melt(
    id_vars=['–ö–æ–º–ø–∞–Ω–∏—è'],
    value_vars=platform_rating_cols,
    var_name='–ü–ª–æ—â–∞–¥–∫–∞',
    value_name='–†–µ–π—Ç–∏–Ω–≥'
)

# ‚úÖ –£–±–∏—Ä–∞–µ–º '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
ratings_melt['–†–µ–π—Ç–∏–Ω–≥'] = ratings_melt['–†–µ–π—Ç–∏–Ω–≥'].replace('–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', np.nan)

# üé® Color scale
color_scale_ratings = alt.Scale(
    domain=list(rating_platform_colors.keys()),
    range=[rating_platform_colors[p] for p in rating_platform_colors.keys()]
)

# üî∑ Chart
line_chart_ratings = alt.Chart(ratings_melt).mark_line(point=True).encode(
    x=alt.X('–ö–æ–º–ø–∞–Ω–∏—è', sort=ratings_df['–ö–æ–º–ø–∞–Ω–∏—è'].tolist(), title='–ö–æ–º–ø–∞–Ω–∏—è'),
    y=alt.Y('–†–µ–π—Ç–∏–Ω–≥', title='–†–µ–π—Ç–∏–Ω–≥', scale=alt.Scale(reverse=True)),
    color=alt.Color('–ü–ª–æ—â–∞–¥–∫–∞', scale=color_scale_ratings, legend=None)
).transform_filter(
    alt.datum.–†–µ–π—Ç–∏–Ω–≥ != None
).properties(width=800)

st.altair_chart(line_chart_ratings)

# üìå ================================
# üî∑ –¶–ò–¢–ê–¢–´ –°–û–¢–†–£–î–ù–ò–ö–û–í
# üìå ================================
st.subheader("–¶–∏—Ç–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º")
selected_company_rating = st.selectbox("–í—ã–±–µ—Ä–∏ –∫–æ–º–ø–∞–Ω–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ü–∏—Ç–∞—Ç—ã", ratings_df['–ö–æ–º–ø–∞–Ω–∏—è'].tolist())

quote_row = ratings_df[ratings_df['–ö–æ–º–ø–∞–Ω–∏—è'] == selected_company_rating]
if not quote_row.empty:
    quote_text = quote_row['–¶–∏—Ç–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (PO)'].values[0]

    st.markdown(
        f"""
        <div style='background-color:black; color:white; padding:20px; border-radius:10px; position:relative;'>
            <span style='position:absolute; top:10px; right:20px; cursor:pointer; font-size:20px;' onclick="this.parentElement.style.display='none';">&times;</span>
            <p>{quote_text}</p>
        </div>
        """,
        unsafe_allow_html=True
    )
